<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision Drink Survey</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <style>
    body {
      background-color: #f4f6f9;
    }

    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.06);
      border: 1px solid #eee;
    }

    .header-title {
      color: #0d6efd;
      font-weight: bold;
    }

    .table-responsive {
      max-height: 520px;
      overflow-y: auto;
    }

    .small-muted {
      font-size: 12px;
      color: #6c757d;
    }

    .input-group-text {
      background-color: #f8f9fa;
      cursor: pointer;
      border-left: 0;
    }

    .form-control.date-text {
      border-right: 0;
    }

    #previewImage {
      max-height: 75vh;
      object-fit: contain;
    }

    /* --- CSS CHO CHATBOX --- */
    #chatBox {
      /* Cho ph√©p k√©o gi√£n */
      resize: both;
      overflow: hidden;

      /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc */
      min-width: 320px;
      min-height: 450px;
      max-width: 95vw;
      max-height: 95vh;

      background-color: #fff;
      transition: bottom 0.3s, right 0.3s;
      /* B·ªè transition width/height ƒë·ªÉ resize m∆∞·ª£t h∆°n */
    }

    /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp */
    #chatContent::-webkit-scrollbar {
      width: 6px;
    }

    #chatContent::-webkit-scrollbar-thumb {
      background-color: #ccc;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-primary mb-3 shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fas fa-eye"></i> Vision Drink Survey</a>
      <span class="navbar-text text-white small-muted">AI Analyst Dashboard</span>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row g-3">

      <div class="col-md-3">
        <div class="card p-3">
          <h5 class="mb-3"><i class="fas fa-filter"></i> B·ªô L·ªçc</h5>

          <label class="form-label">T·ª´ th·ªùi gian:</label>
          <div class="input-group mb-1">
            <input type="text" id="startDate" class="form-control date-text" placeholder="DD/MM/YYYY" maxlength="10"
              oninput="formatDateInput(this)" onkeypress="handleEnter(event)" />
            <input type="date" id="startDatePicker" class="form-control"
              style="max-width: 40px; padding: 0 5px; color: transparent;" onchange="syncDate('start')"
              title="Ch·ªçn t·ª´ l·ªãch" />
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text border-end-0"><i class="fas fa-clock"></i></span>
            <input type="time" id="startTime" class="form-control" onkeypress="handleEnter(event)" />
          </div>

          <label class="form-label">ƒê·∫øn th·ªùi gian:</label>
          <div class="input-group mb-1">
            <input type="text" id="endDate" class="form-control date-text" placeholder="DD/MM/YYYY" maxlength="10"
              oninput="formatDateInput(this)" onkeypress="handleEnter(event)" />
            <input type="date" id="endDatePicker" class="form-control"
              style="max-width: 40px; padding: 0 5px; color: transparent;" onchange="syncDate('end')"
              title="Ch·ªçn t·ª´ l·ªãch" />
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text border-end-0"><i class="fas fa-clock"></i></span>
            <input type="time" id="endTime" class="form-control" onkeypress="handleEnter(event)" />
          </div>

          <label class="form-label">T√™n s·∫£n ph·∫©m:</label>
          <input type="text" id="productFilter" class="form-control mb-3" placeholder="V√≠ d·ª•: coca, c2..."
            onkeypress="handleEnter(event)" />

          <button class="btn btn-primary w-100 mb-2 mt-2" onclick="onSearch()">
            <i class="fas fa-search"></i> T√¨m ki·∫øm
          </button>
          <button class="btn btn-success w-100" onclick="exportExcel()">
            <i class="fas fa-file-excel"></i> Xu·∫•t Excel
          </button>

          <div class="mt-3 small text-muted">
            Realtime: <span id="rtStatus">ƒêang k·∫øt n·ªëi...</span>
          </div>
        </div>
      </div>

      <div class="col-md-9">

        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="header-title mb-0">Bi·ªÉu ƒë·ªì xu h∆∞·ªõng</h5>
            <span class="badge bg-secondary" id="totalCount">T·ªëi ƒëa: 0 b·∫£n ghi</span>
          </div>
          <div style="height: 300px; margin-top: 12px;">
            <canvas id="drinkBarChart"></canvas>
          </div>
        </div>

        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="header-title mb-0">D·ªØ Li·ªáu Chi Ti·∫øt</h5>
            <small class="text-muted">T·ª± ƒë·ªông c·∫≠p nh·∫≠t ‚Ä¢ Hi·ªán: <span id="loadedCount">0</span> d√≤ng</small>
          </div>

          <div class="table-responsive" id="tableContainer">
            <table class="table table-hover table-striped align-middle">
              <thead class="table-dark sticky-top">
                <tr>
                  <th>ID</th>
                  <th>Th·ªùi gian</th>
                  <th>S·∫£n ph·∫©m ph√°t hi·ªán</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <button class="btn btn-primary rounded-circle shadow"
    style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 9999;" onclick="toggleChat()"
    title="H·ªèi Tr·ª£ l√Ω AI">
    <i class="fas fa-robot fa-lg"></i>
  </button>

  <div id="chatBox" class="card shadow"
    style="position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px; z-index: 9999; display: none; flex-direction: column;">

    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <i class="fas fa-magic"></i>
        <span class="fw-bold">Tr·ª£ l√Ω Ph√¢n T√≠ch</span>
      </div>
      <div>
        <button type="button" class="btn btn-sm btn-link text-white text-decoration-none me-1"
          onclick="toggleMaximizeChat()" title="Ph√≥ng to">
          <i class="fas fa-expand" id="btnExpandIcon"></i>
        </button>
        <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
      </div>
    </div>

    <div class="card-body p-2" id="chatContent" style="overflow-y: auto; flex: 1; background: #f8f9fa;">
      <div class="text-center text-muted small mt-3">
        üëã Xin ch√†o! M√¨nh l√† chuy√™n gia ph√¢n t√≠ch d·ªØ li·ªáu.<br>
        M√¨nh c√≥ th·ªÉ t√¨m Insight t·ª´ h√†nh vi ti√™u d√πng.<br>
        <i>(K√©o g√≥c d∆∞·ªõi ph·∫£i ƒë·ªÉ m·ªü r·ªông khung chat)</i>
      </div>
    </div>

    <div class="card-footer p-2">
      <div class="input-group">
        <input type="text" id="chatInput" class="form-control" placeholder="H·ªèi v·ªÅ xu h∆∞·ªõng, l·ªùi khuy√™n..."
          onkeypress="handleChatEnter(event)">
        <button class="btn btn-primary" onclick="sendChat()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xem ·∫£nh g·ªëc</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="previewImage" src="" class="img-fluid rounded" alt="Preview" />
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ================= LOGIC C≈® (B·∫£ng, Bi·ªÉu ƒë·ªì) ================= */
    let chart;
    function qs(id) { return document.getElementById(id); }

    const PAGE_SIZE = 20;
    let cursorId = null;
    let loading = false;
    let reachedEnd = false;

    let es = null;
    let lastSeenId = 0;
    const MAX_ROWS_DOM = 1000;

    function formatDateInput(input) {
      let val = input.value.replace(/\D/g, '');
      if (val.length > 2) val = val.substring(0, 2) + '/' + val.substring(2);
      if (val.length > 5) val = val.substring(0, 5) + '/' + val.substring(5, 9);
      input.value = val;
    }

    function syncDate(type) {
      const picker = qs(type + 'DatePicker');
      const input = qs(type + 'Date');
      if (picker.value) {
        const parts = picker.value.split('-');
        if (parts.length === 3) {
          input.value = `${parts[2]}/${parts[1]}/${parts[0]}`;
          onSearch();
        }
      }
    }

    function toIsoDate(str) {
      if (!str) return "";
      const parts = str.split('/');
      if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
      return str;
    }

    function handleEnter(event) {
      if (event.key === 'Enter') onSearch();
    }

    function getFilters() {
      let rawStart = qs('startDate').value;
      let rawEnd = qs('endDate').value;
      let timeStart = qs('startTime').value;
      let timeEnd = qs('endTime').value;

      let isoStart = toIsoDate(rawStart);
      let isoEnd = toIsoDate(rawEnd);

      if (isoStart && timeStart) isoStart += ' ' + timeStart;
      if (isoEnd && timeEnd) isoEnd += ' ' + timeEnd;

      return {
        start: isoStart,
        end: isoEnd,
        product: qs('productFilter').value || ""
      };
    }

    function setRtStatus(text) { qs("rtStatus").innerText = text; }

    async function loadTotalMaxCount() {
      try {
        const res = await fetch("/api/count_all");
        const data = await res.json();
        qs("totalCount").innerText = `T·ªëi ƒëa: ${data.total} b·∫£n ghi`;
      } catch (e) { console.error(e); }
    }

    function updateLoadedCount() {
      qs("loadedCount").innerText = String(qs("tableBody").children.length);
    }

    function makeRow(item) {
      const imgUrl = `/uploads/${encodeURIComponent(item.image_path || "")}`;
      const tr = document.createElement('tr');
      tr.setAttribute("data-id", String(item.id));
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.timestamp}</td>
        <td style="font-weight:bold; color:#0d6efd;">${item.product_name}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="previewImage('${imgUrl}')">
            <i class="fas fa-image"></i> Xem
          </button>
        </td>
      `;
      return tr;
    }

    function trimAfterPrepend() {
      const tbody = qs("tableBody");
      while (tbody.children.length > MAX_ROWS_DOM) {
        tbody.removeChild(tbody.lastChild);
      }
    }

    function trimAfterAppendKeepScroll() {
      const tbody = qs("tableBody");
      const container = qs("tableContainer");

      while (tbody.children.length > MAX_ROWS_DOM) {
        const first = tbody.firstChild;
        if (!first) break;
        const h = first.getBoundingClientRect().height || 0;
        tbody.removeChild(first);
        container.scrollTop = Math.max(0, container.scrollTop - h);
      }
    }

    function prependRow(item) {
      const tbody = qs("tableBody");
      if (tbody.querySelector(`tr[data-id="${item.id}"]`)) return;
      const tr = makeRow(item);
      tbody.insertBefore(tr, tbody.firstChild);
      trimAfterPrepend();
      updateLoadedCount();
    }

    function appendRows(data) {
      const tbody = qs("tableBody");
      data.forEach(item => {
        if (tbody.querySelector(`tr[data-id="${item.id}"]`)) return;
        tbody.appendChild(makeRow(item));
      });
      trimAfterAppendKeepScroll();
      updateLoadedCount();
    }

    async function loadFirstPage() {
      cursorId = null;
      reachedEnd = false;
      loading = false;
      qs("tableBody").innerHTML = "";

      await loadDataPage(true);

      const first = qs("tableBody").firstChild;
      if (first) {
        const id = parseInt(first.getAttribute("data-id") || "0", 10);
        if (!isNaN(id)) lastSeenId = Math.max(lastSeenId, id);
      }
      updateLoadedCount();
    }

    async function loadDataPage(isReset = false) {
      if (loading || reachedEnd) return;
      loading = true;

      const f = getFilters();
      let url = `/api/data?start_date=${encodeURIComponent(f.start)}&end_date=${encodeURIComponent(f.end)}&product=${encodeURIComponent(f.product)}&limit=${PAGE_SIZE}`;
      if (cursorId !== null) url += `&cursor_id=${cursorId}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (isReset) qs('tableBody').innerHTML = '';

        if (!data || data.length === 0) {
          if (cursorId === null) {
            qs('tableBody').innerHTML = '<tr><td colspan="4" class="text-center">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>';
          }
          reachedEnd = true;
          return;
        }
        appendRows(data);
        cursorId = data[data.length - 1].id;
        if (data.length < PAGE_SIZE) reachedEnd = true;
      } catch (e) { console.error(e); } finally { loading = false; }
    }

    function stopStream() {
      if (es) { try { es.close(); } catch (_) { } es = null; }
    }

    function startStream() {
      stopStream();
      const f = getFilters();
      const url = `/api/stream?start_date=${encodeURIComponent(f.start)}&end_date=${encodeURIComponent(f.end)}&product=${encodeURIComponent(f.product)}&last_id=${lastSeenId}`;
      es = new EventSource(url);
      setRtStatus("ƒêang ch·∫°y");
      es.addEventListener("new", (ev) => {
        try {
          const item = JSON.parse(ev.data);
          if (item && item.id) {
            lastSeenId = Math.max(lastSeenId, parseInt(item.id, 10) || 0);
            prependRow(item);
            loadStats();
          }
        } catch (e) { console.error(e); }
      });
      es.onerror = () => setRtStatus("M·∫•t k·∫øt n·ªëi... t·ª± n·ªëi l·∫°i");
      es.onopen = () => setRtStatus("ƒêang ch·∫°y");
    }

    async function loadStats() {
      const f = getFilters();
      const url = `/api/stats?start_date=${encodeURIComponent(f.start)}&end_date=${encodeURIComponent(f.end)}&product=${encodeURIComponent(f.product)}`;
      try {
        const res = await fetch(url);
        const stats = await res.json();
        renderChart(stats);
      } catch (e) { console.error(e); }
    }

    function renderChart(stats) {
      const labels = (stats || []).map(x => x.label);
      const values = (stats || []).map(x => x.count);
      const ctx = document.getElementById('drinkBarChart').getContext('2d');
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
      const bgColors = labels.map((_, i) => colors[i % colors.length]);

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.data.datasets[0].backgroundColor = bgColors;
        chart.update();
        return;
      }

      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: values, backgroundColor: bgColors, borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    }

    function exportExcel() {
      const f = getFilters();
      const url = `/export_excel?start_date=${encodeURIComponent(f.start)}&end_date=${encodeURIComponent(f.end)}&product=${encodeURIComponent(f.product)}`;
      window.location.href = url;
    }

    function previewImage(url) {
      const img = document.getElementById("previewImage");
      img.src = url;
      const modalEl = document.getElementById("imagePreviewModal");
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }

    function setupInfiniteScroll() {
      const container = qs('tableContainer');
      container.addEventListener('scroll', async () => {
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 80) {
          await loadDataPage(false);
        }
      });
    }

    async function onSearch() {
      lastSeenId = 0;
      stopStream();
      await loadFirstPage();
      await loadStats();
      startStream();
    }

    setInterval(() => loadStats(), 10000);

    /* ================= CHAT UI & LOGIC (N√¢ng c·∫•p) ================= */

    // Bi·∫øn tr·∫°ng th√°i ph√≥ng to
    let isMaximized = false;
    // L∆∞u l·∫°i k√≠ch th∆∞·ªõc ban ƒë·∫ßu tr∆∞·ªõc khi ph√≥ng
    const originalStyle = { width: "350px", height: "500px", bottom: "100px", right: "30px" };

    function toggleChat() {
      const box = document.getElementById('chatBox');
      const isHidden = (box.style.display === 'none');
      box.style.display = isHidden ? 'flex' : 'none';
      if (isHidden) setTimeout(() => document.getElementById('chatInput').focus(), 100);
    }

    function toggleMaximizeChat() {
      const box = document.getElementById('chatBox');
      const icon = document.getElementById('btnExpandIcon');

      if (!isMaximized) {
        // L∆∞u l·∫°i k√≠ch th∆∞·ªõc hi·ªán t·∫°i (ph√≤ng tr∆∞·ªùng h·ª£p user ƒë√£ k√©o tay)
        originalStyle.width = box.style.width;
        originalStyle.height = box.style.height;

        // Ph√≥ng to g·∫ßn nh∆∞ to√†n m√†n h√¨nh
        box.style.width = "90vw";
        box.style.height = "85vh";
        box.style.bottom = "20px";
        box.style.right = "5vw"; // CƒÉn gi·ªØa

        icon.classList.remove('fa-expand');
        icon.classList.add('fa-compress');
        isMaximized = true;
      } else {
        // Thu nh·ªè v·ªÅ k√≠ch th∆∞·ªõc c≈©
        box.style.width = originalStyle.width;
        box.style.height = originalStyle.height;
        box.style.bottom = "100px";
        box.style.right = "30px";

        icon.classList.remove('fa-compress');
        icon.classList.add('fa-expand');
        isMaximized = false;
      }
    }

    function handleChatEnter(e) {
      if (e.key === 'Enter') sendChat();
    }

    // --- H√ÄM N√ÄY ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ƒê·ªÇ HI·ªÇN TH·ªä N√öT T·∫¢I FILE ---
    function appendMessage(role, text) {
      const content = document.getElementById('chatContent');
      const div = document.createElement('div');
      const isUser = (role === 'user');

      div.className = `d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-2`;
      const bgClass = isUser ? 'bg-primary text-white' : 'bg-white border text-dark';

      // 1. D√πng Markdown ƒë∆°n gi·∫£n ƒë·ªÉ format
      let formattedText = text.replace(/\n/g, '<br>');

      // 2. In ƒë·∫≠m (**)
      formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

      // 3. X·ª≠ l√Ω LINK T·∫¢I FILE: [T√™n Link](URL) -> N√∫t b·∫•m t·∫£i xu·ªëng
      formattedText = formattedText.replace(
        /\[([^\]]+)\]\(([^)]+)\)/g,
        '<a href="$2" target="_blank" style="text-decoration: underline; font-weight: bold; color: ' + (isUser ? 'white' : '#0d6efd') + '">$1 <i class="fas fa-download"></i></a>'
      );

      div.innerHTML = `
        <div class="p-2 rounded ${bgClass}" style="max-width: 85%; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
             ${formattedText}
        </div>
      `;

      content.appendChild(div);
      content.scrollTop = content.scrollHeight;
      return div; // Tr·∫£ v·ªÅ div ƒë·ªÉ c√≥ th·ªÉ x√≥a n·∫øu c·∫ßn (loading)
    }

    async function sendChat() {
      const input = document.getElementById('chatInput');
      const q = input.value.trim();
      if (!q) return;

      appendMessage("user", q);
      input.value = '';
      input.disabled = true;

      const loadingMsg = appendMessage("ai", "typing...");
      loadingMsg.querySelector('div').style.fontStyle = 'italic';
      loadingMsg.querySelector('div').style.color = '#6c757d';

      try {
        const f = getFilters();
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: q,
            start_date: f.start,
            end_date: f.end,
            product: f.product
          })
        });

        const data = await res.json();
        loadingMsg.remove(); // X√≥a tin nh·∫Øn loading
        appendMessage("ai", data.answer);

      } catch (e) {
        console.error(e);
        loadingMsg.remove();
        appendMessage("ai", "‚ö†Ô∏è L·ªói k·∫øt n·ªëi server.");
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    window.onload = async () => {
      setupInfiniteScroll();
      await loadTotalMaxCount();
      await onSearch();
    };
  </script>
</body>

</html>